# 1670650

nfs lock 不成功

```
[root@redhat75 ~]# ./test.sh /tmp

Test locking file: /tmp/flock-user-test.7901
flock: 10: Bad file descriptor
Lock failed: 65
flock: 10: Bad file descriptor
Unlock failed: 65
```

```bash
#!/bin/bash
# Usage: $0 <directory> [<directory>...]

for directory in $@
do
    test_file="$directory/flock-user-test.$$"
    printf "\nTest locking file: %s\n" "$test_file"
    touch "$test_file"
    {
        #fuser "$test_file"
        flock -w 2 -x $test_fd || printf "Lock failed: %d\n" $?
        #ls -l /proc/$$/fd
        #fuser "$test_file"
        flock -u -x $test_fd || printf "Unlock failed: %d\n" $?
    } {test_fd}<"$test_file"
    rm -f "$test_file"
done

```
经过验证, ARM平台上redhat7.4 ok, 7.5 no, 7.6 no, 8.0 ok，X86平台上 7.6 ok，如下表

|  架构 | 版本  |       |       |        |
|:------|:------|:------|:------|:-------|  
|       |RHEL7.4|RHEL7.5|RHEL7.6|RHEL 8.0|
|X86    |-      |-      |ok     |-       |
|aarch64|ok     |fail   |fail   |ok      |

各redhat版本对应的内核版本如下
```
RHEL7.4  4.11.0-44.el7a.aarch64
RHEL7.5  4.14.0-49.el7a.aarch64
RHEL7.6  4.14.0-115.el7a.aarch64
RHEL8.0  4.18.0-64.el8.aarch64
```

## strace 跟踪
```
strace -ff -o strace-thread-output ./test.sh /tmp
```
是在执行flock系统调用的时候失败，主要差异是：  
```
RHEL7.6 flock(10,LOCK_EX)   = -1 EBADF(Bad file descriptor)
RHEL7.4 flock(10,LOCK_EX)   = 0
```
## nfs flock内核代码跟踪
```
git log --oneline kernel-alt-4.11.0-44.el7a..kernel-4.18.0-64.el8 -- fs/nfs
```
查找相关提交，锁定两个commit：
```
e129372 NFS: Move the flock open mode check into nfs_flock()
fcfa447 NFS: Revert "NFS: Move the flock open mode check into nfs_flock()"
```
再分析出现的位置
```
RHEL8.0  4.18.0-64.el8.aarch64      kernel-4.18.0-64.el8

fcfa447 NFS: Revert "NFS: Move the flock open mode check into nfs_flock()"

RHEL7.6  4.14.0-115.el7a.aarch64    kernel-alt-4.14.0-115.el7a   
RHEL7.5  4.14.0-49.el7a.aarch64     kernel-alt-4.14.0-49.el7a

e129372 NFS: Move the flock open mode check into nfs_flock()

RHEL7.4  4.11.0-44.el7a.aarch64     kernel-alt-4.11.0-44.el7a
```
和测试现象一致。

## 编译新内核验证

在内核代码根目录，切换到redhat7.6的内核代码
```
git checkout -b fix_flock kernel-alt-4.14.0-115.el7a
```
合入commit fcfa447
```
git cherry-pick fcfa447
```
添加内核编译配置文件
```
cp ~/config-4.14.0-115.el7a.aarch64 .config
```
执行编译脚本
```
build-kernel-natively.sh
```
复制内核文件到目标主机
```
scp /root/rpmbuild/RPMS/aarch64/kernel-4.14.0_alt_115_fix_nfs_flock_2019_02_01-3.aarch64.rpm me@192.168.1.126:~/
```
执行安装并重启
```
yum install kernel-4.14.0_alt_115_fix_nfs_flock_2019_02_01-3.aarch64.rpm
reboot -f
```
选择新内核启动系统
```


      Red Hat Enterprise Linux Server (4.14.0-alt-115-fix-nfs-flock-2019-02-01>
      Red Hat Enterprise Linux Server (4.14.0-115.el7a.aarch64) 7.6 (Maipo)
      Red Hat Enterprise Linux Server (0-rescue-f0b91f9908f44910b44f62583e5da5>














      Use the ^ and v keys to change the selection.
      Press 'e' to edit the selected item, or 'c' for a command prompt.


```
确认版本更新
```
[root@redhat76 ~]# uname -a
Linux redhat76 4.14.0-alt-115-fix-nfs-flock-2019-02-01 #3 SMP Fri Feb 1 15:47:15 CST 2019 aarch64 aarch64 aarch64 GNU/Linux
[root@redhat76 ~]# cat /etc/redhat-release
Red Hat Enterprise Linux Server release 7.6 (Maipo)
```
重新验证成功
```
[root@redhat76 ~]# ./test.sh /tmp
+ for directory in '$@'
+ test_file=/tmp/flock-user-test.9916
+ printf '\nTest locking file: %s\n' /tmp/flock-user-test.9916

Test locking file: /tmp/flock-user-test.9916
+ touch /tmp/flock-user-test.9916
+ flock -w 2 -x 10
+ flock -u -x 10
+ rm -f /tmp/flock-user-test.9916
```

